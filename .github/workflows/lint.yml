name: Lint

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '**/*.php'
      - '**/*.js'
      - '**/*.css'
      - 'composer.json'
      - 'composer.lock'
      - 'package.json'
      - 'biome.json'
      - 'phpstan.neon'
      - 'languages/*.pot'
  pull_request:
    paths:
      - '**/*.php'
      - '**/*.js'
      - '**/*.css'
      - 'composer.json'
      - 'composer.lock'
      - 'package.json'
      - 'biome.json'
      - 'phpstan.neon'
      - 'languages/*.pot'

jobs:
  php:
    name: PHP ${{ matrix.php }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php: ["8.3", "8.4"]

    steps:
      - uses: actions/checkout@v6

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: curl
          coverage: none
          tools: composer:v2, cs2pr

      - name: Validate PHP syntax
        run: find . -maxdepth 1 -name '*.php' -exec php --syntax-check {} +

      - name: Validate composer.json
        run: composer validate --no-check-publish

      - run: composer install --no-progress --prefer-dist --optimize-autoloader --no-suggest

      - run: vendor/bin/phpcs -q --report=checkstyle | cs2pr

      - run: ./vendor/bin/phpstan analyse --error-format=checkstyle | cs2pr

      - name: Run wp-plugin-check
        if: matrix.php == '8.3'
        uses: wordpress/plugin-check-action@v1
        with:
          exclude-checks: |
            late_escaping
            plugin_review_phpcs
            file_type
            plugin_readme

  biome:
    name: Biome
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: npm

      - run: npm ci

      - run: npm run lint

  translations:
    name: Translations
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: wp-cli

      - name: Check for missing translation strings
        run: |
          # Generate fresh POT file
          wp i18n make-pot . languages/zw-knabbel-wp-new.pot --slug=zw-knabbel-wp --domain=zw-knabbel-wp --skip-audit

          # Extract msgid lines from both files
          grep "^msgid " languages/zw-knabbel-wp.pot | sort > /tmp/old-strings.txt
          grep "^msgid " languages/zw-knabbel-wp-new.pot | sort > /tmp/new-strings.txt

          # Find strings in code but not in POT file
          MISSING=$(comm -13 /tmp/old-strings.txt /tmp/new-strings.txt)

          if [ -n "$MISSING" ]; then
            echo "::error::Missing translation strings in POT file:"
            echo "$MISSING"
            echo ""
            echo "Run 'wp i18n make-pot . languages/zw-knabbel-wp.pot' to update"
            exit 1
          fi

          echo "All translation strings are present in POT file"
